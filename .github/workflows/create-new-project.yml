name: Create New Project

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Name of the new project'
        required: true

jobs:
  create-project:
    runs-on: ubuntu-latest

    steps:
    - name: Create Repositories
      id: create_repos
      run: |
        project_name="${{ github.event.inputs.project_name }}"
        main_repo="Javid1e/${project_name}"
        backend_repo="Javid1e/${project_name}_backend"
        frontend_repo="Javid1e/${project_name}_frontend"
        dockerize_repo="Javid1e/${project_name}_dockerize"

        # Create main repository
        curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" https://api.github.com/user/repos -d "{\"name\":\"${project_name}\"}"

        # Create submodule repositories
        curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" https://api.github.com/user/repos -d "{\"name\":\"${project_name}_backend\"}"
        curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" https://api.github.com/user/repos -d "{\"name\":\"${project_name}_frontend\"}"
        curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" https://api.github.com/user/repos -d "{\"name\":\"${project_name}_dockerize\"}"

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git config --global url."https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/".insteadOf "https://github.com/"

    - name: Initialize New Project
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        project_name="${{ github.event.inputs.project_name }}"
        main_repo_url="https://github.com/Javid1e/${project_name}.git"
        backend_repo_url="https://github.com/Javid1e/${project_name}_backend.git"
        frontend_repo_url="https://github.com/Javid1e/${project_name}_frontend.git"
        dockerize_repo_url="https://github.com/Javid1e/${project_name}_dockerize.git"

        new_project_dir=$project_name

        # Clone template repository with authentication
        git clone --recurse-submodules https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/Javid1e/full_django_nextjs_dockerize_template.git $new_project_dir
        cd $new_project_dir

        # Set new remotes for the main project
        git remote set-url origin $main_repo_url

        # Set new remotes for submodules
        git submodule set-url backend $backend_repo_url
        git submodule set-url frontend $frontend_repo_url
        git submodule set-url dockerize $dockerize_repo_url
        git submodule update --init --recursive

        # Push changes to the main repository
        git push -u origin main

    - name: Setup Frontend Branch
      run: |
        cd $new_project_dir
        git checkout -b frontend
        git submodule update --init --recursive
        cd frontend
        git remote set-url origin $frontend_repo_url
        git push -u origin main
        cd ..
        git add .
        git commit -m "Setup frontend branch"
        git push origin frontend

    - name: Setup Backend Branch
      run: |
        cd $new_project_dir
        git checkout -b backend
        git submodule update --init --recursive
        cd backend
        git remote set-url origin $backend_repo_url
        git push -u origin main
        cd ..
        git add .
        git commit -m "Setup backend branch"
        git push origin backend

    - name: Setup Dockerize Branch
      run: |
        cd $new_project_dir
        git checkout -b dockerize
        git submodule update --init --recursive
        cd dockerize
        git remote set-url origin $dockerize_repo_url
        git push -u origin main
        cd ..
        git add .
        git commit -m "Setup dockerize branch"
        git push origin dockerize
